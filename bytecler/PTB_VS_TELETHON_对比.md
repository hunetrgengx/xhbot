# PTB 霜刃 vs 原 Telethon 霜刃 - 功能对比

## 一、总览

| 维度 | 原 Telethon 版 | 当前 PTB 版 |
|------|----------------|-------------|
| 框架 | Telethon (MTProto) | python-telegram-bot (Bot API) |
| 依赖 | telethon, API_ID, API_HASH | 仅 BOT_TOKEN |
| 可获取用户 bio | ✅ | ❌（Bot API 不支持） |

---

## 二、功能实现对比

| 序号 | 功能 | 原 Telethon | 当前 PTB | 说明 |
|------|------|-------------|----------|------|
| 1 | 群消息文本垃圾关键词 → 人机验证 | ✅ | ✅ | 完全一致 |
| 2 | 群消息昵称垃圾关键词 → 人机验证 | ✅ | ✅ | 完全一致 |
| 3 | 群消息**简介(bio)**垃圾关键词 → 人机验证 | ✅ | ❌ | PTB 无法获取 bio |
| 4 | 简介含 tg/http/@ 链接 → 人机验证 | ✅ | ❌ | 同上 |
| 5 | 广告判定（网页预览+短文本≤10）→ 人机验证 | ✅ | ✅ | 已实现 |
| 6 | 引用非本群消息 → 人机验证 | ✅ | ✅ | 已实现 |
| 7 | 验证码通过/失败、失败 5 次限制 | ✅ | ✅ | 完全一致 |
| 8 | 白名单用户 AI 唤醒（霜刃，/@bot） | ✅ | ✅ | 已实现 |
| 9 | handoff 小助理转接（霜刃说「小助理你来回答」） | ✅ | ✅ | 已实现 |
| 10 | 抽奖白名单同步（启动全量 + 每日定时） | ✅ | ✅ | 已实现 |
| 11 | 新成员入群、机器人自动加入白名单 | ✅ | ✅ | 完全一致 |
| 12 | 管理员限制/封禁用户 → 自动加黑名单 | ✅ | ✅ | 完全一致 |
| 13 | 用户被踢出 → 加黑名单 | ✅ | ✅ | 完全一致 |
| 14 | 私聊命令：/list、/reload、/verified_stats | ✅ | ✅ | 完全一致 |
| 15 | 私聊命令：/kw_text、/kw_name、/kw_bio 关键词管理 | ✅ | ✅ | 已实现 |
| 16 | 私聊命令：/cancel | ✅ | ✅ | 已实现 |
| 17 | 私聊发送群消息链接 → 返回验证过程 | ✅ | ❌ | 需 MTProto get_messages |
| 18 | 「查看原始 JSON」按钮 | ✅ | ❌ | 同上 |
| 19 | 启动时群发「你好」、抽奖同步结果通知 | ✅ | ✅ | 已实现 |
| 20 | 非白名单消息 2s 延迟（防删消息后跳过流程） | ✅ | ✅ | 已实现 |

---

## 三、PTB 已实现（与原版一致或等效）

- 垃圾关键词过滤（text、name）
- 人机验证流程（验证码、5 次失败限制）
- 白名单 / 黑名单 / 验证失败记录
- 封禁 / 限制 / 踢出事件监听与黑名单同步
- 新成员入群、机器人自动加白名单
- 广告判定（网页链接+短文本≤10）
- 引用非本群消息判定
- 2s 延迟防删消息
- AI 唤醒（霜刃/@bot）+ handoff 小助理转接
- handoff frost_reply 代为发送「......」
- 抽奖白名单同步（启动 + 每日 4:00 UTC）
- 启动时群发「你好」
- 私聊命令：/list、/reload、/verified_stats、/kw_text、/kw_name、/kw_bio、/cancel

---

## 四、PTB 未实现或不可实现

### 4.1 API 限制（PTB 无法实现）

| 功能 | 原因 |
|------|------|
| 简介(bio) 关键词/链接检测 | Bot API 不提供获取用户 bio |
| 私聊链接解析（t.me/xxx/123） | Bot API 无法按 chat_id+msg_id 拉取消息 |
| 查看原始 JSON 按钮 | 依赖上一条 |

### 4.2 已全部实现（原「逻辑未实现」）

以下功能已实现：
- AI 唤醒、handoff、抽奖同步、广告判定、引用非本群、/kw_*、/cancel、启动你好、2s 延迟

---

## 五、未实现功能的原因分析

### 5.1 改造背景与优先级

PTB 改造的出发点是在**移除 Telethon 后保留霜刃的核心反垃圾能力**，因此优先完成了：文本/昵称关键词、人机验证、白名单黑名单、封禁监听等核心逻辑。其余功能因以下原因暂未迁移。

---

### 5.2 各功能未实现的原因

| 功能 | 未实现原因 |
|------|------------|
| **AI 唤醒** | 1）原版依赖 `me.id`、`me.username` 做触发判断，PTB 需在 Application 初始化后获取 bot 信息；2）需接入 KIMI API，存在 token 配置与错误处理；3）改造时以「先跑通主流程」为主，AI 为辅。 |
| **handoff 小助理转接** | 1）需另起后台任务轮询 `handoff_pending.jsonl`；2）与 xhchat 同进程时共享 handoff 模块，需保证导入路径和运行环境正确；3）属于霜刃与 xhchat 的协同逻辑，改造时未一并迁移。 |
| **抽奖白名单同步** | 1）依赖 `LOTTERY_DB_PATH` 指向的 SQLite，路径与环境随部署变化；2）需要 `asyncio` 后台定时任务；3）与核心反垃圾无直接关系，优先级较低。 |
| **广告判定（网页+短文本）** | 1）需判断 `message.effective_attachment` 或 `message.link_preview_options` 等；2）PTB v20 与 Telethon 消息结构不同，需重新适配；3）改造时聚焦文本/昵称关键词，未细化到消息类型。 |
| **引用非本群消息判定** | 1）需从 `reply_to_message.forward_origin` 等字段判断跨群引用；2）PTB 的 `Message` 结构与 Telethon 不同，需单独梳理；3）属于边界场景，优先级低于主流程。 |
| **/kw_text、/kw_name、/kw_bio** | 1）原版有 `pending_keyword_cmd` 状态机，需在 PTB 中用 `ConversationHandler` 或自定义状态实现；2）涉及对 shared 的 `spam_keywords` 增删及 `_save_spam_keywords` 调用；3）管理功能，不影响普通用户使用，改造时未优先迁移。 |
| **/cancel** | 1）依赖 `pending_keyword_cmd` 等状态；2）在 `/kw_*` 未实现的前提下，`/cancel` 作用有限；3）可与 `/kw_*` 一起补全。 |
| **启动时群发「你好」** | 1）可在 `Application.post_init` 或首次 `start_polling` 后发送；2）与抽奖同步强绑定，抽奖同步未做时，「你好」单独补意义不大；3）实现简单，属于锦上添花。 |
| **2s 延迟防删消息** | 1）原版用 `asyncio.sleep(2)` 后再 `get_messages` 检查，PTB 无等价「按 id 拉消息」接口；2）只能通过「先 sleep 2s 再处理」来近似，无法精确判断消息是否已被删除；3）防的是用户秒删消息逃避检测，属次要优化，改造时未实现。 |

---

### 5.3 总结

- **主要原因**：改造以「核心反垃圾能力可运行」为目标，其余能力按优先级后置。
- **技术因素**：PTB 与 Telethon 的消息、状态机模型不同，部分逻辑需重写而非照搬。
- **依赖与协同**：AI、handoff、抽奖同步依赖外部服务、文件和进程协同，改造时未一并迁移。
- **可补全性**：以上功能均可在现有 PTB 架构上逐步补齐，无 API 层面的硬性限制。

---

## 六、简要结论

- **PTB 已实现**：文本/昵称关键词、人机验证、白名单黑名单、封禁监听、广告判定、引用非本群、2s 延迟、AI 唤醒、handoff、抽奖同步、关键词管理、启动你好
- **PTB 无法实现**：bio 相关（Bot API 限制）、私聊链接解析（需 MTProto）
- **影响**：简介含链接的用户不会被自动触发验证，会直接加白名单，反垃圾能力略弱于原版
