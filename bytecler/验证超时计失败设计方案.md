# 验证超时计失败 - 设计方案

## 一、问题

用户通过「每次间隔 > 90 秒发违禁词」可规避限制：
- 每次发违禁词 → 触发验证 → 下发验证码
- 90 秒内不回复 → 超时，`pending_verification.pop`，**不增加**失败次数
- 再次发违禁词 → 重新触发验证，失败次数始终为 0
- 结果：可无限发违禁词而不被限制

## 二、方案：验证超时视为失败

### 2.1 核心逻辑

当用户**验证超时**（90 秒内未正确回复）后**再次触发验证**时：
- 将此次「超时」视为 **1 次失败**
- 调用 `increment_verification_failures(chat_id, uid)`
- 若窗口内失败次数 ≥ 5 → 执行限制
- 然后正常触发新的验证流程

### 2.2 代码改动位置

`group_message_handler` 中，`pending_verification` 的超时分支：

```python
# 当前逻辑
if time.time() - pb["time"] <= VERIFY_TIMEOUT:
    # 正确/错误处理...
else:
    pending_verification.pop(key, None)  # 超时：直接 pop，不计数
```

**改为**：

```python
else:
    # 超时 = 未完成验证，计 1 次失败
    cnt = increment_verification_failures(chat_id, uid)
    save_verification_failures()
    msg_id = pb.get("msg_id")
    if cnt >= VERIFY_FAIL_THRESHOLD:
        await _restrict_and_notify(context.bot, chat_id, uid, f"{first_name} {last_name}", msg_id)
    pending_verification.pop(key, None)
```

### 2.3 复用现有机制

- **冷却**：`TRIGGER_COOLDOWN_SECONDS`（默认 15 秒）— 超时后 15 秒内再次触发不计入
- **窗口**：`TRIGGER_WINDOW_SECONDS`（默认 20 分钟）— 窗口内 5 次即限制
- **保留期**：`VERIFY_FAILURES_RETENTION_SECONDS`（24 小时）— 过期自动清理

### 2.4 行为对比

| 场景 | 原逻辑 | 新逻辑 |
|------|--------|--------|
| 90 秒内发错 5 次 | 限制 ✓ | 限制 ✓ |
| 90 秒内正确回复 | 加白 ✓ | 加白 ✓ |
| 90 秒内不回复，之后发违禁词 | 不计数，新验证 | **计 1 次失败**，新验证 |
| 20 分钟内超时 5 次 | 不限制 | **限制** ✓ |

### 2.5 时间线示例

用户 13:49、13:57、14:01、14:05、14:08 各发一次违禁词，均不回复验证码：

| 时间 | 操作 | 失败次数 | 结果 |
|------|------|----------|------|
| 13:49 | 违禁词 → 验证 | 0 | 下发验证码 |
| 13:57 | 违禁词（超时） | 1 | 计失败，新验证 |
| 14:01 | 违禁词（超时） | 2 | 计失败，新验证 |
| 14:05 | 违禁词（超时） | 3 | 计失败，新验证 |
| 14:08 | 违禁词（超时） | 4 | 计失败，新验证 |
| 14:12 | 违禁词（超时） | 5 | **限制** ✓ |

## 三、边界情况

1. **超时后立刻发违禁词**：若间隔 < 15 秒，冷却不计入（避免同一「轮」重复计数）
2. **超时后发正确验证码**：不会发生，超时后 `pending_verification` 已 pop，用户发验证码会走「首次发言」等逻辑，不会匹配旧 code
3. **限制时的 msg_id**：使用超时那次验证对应的 `msg_id`，用于更新验证记录

## 四、配置项（沿用）

| 配置 | 默认 | 说明 |
|------|------|------|
| VERIFY_TIMEOUT | 90 | 验证码有效秒数 |
| VERIFY_FAIL_THRESHOLD | 5 | 失败次数阈值 |
| TRIGGER_COOLDOWN_SECONDS | 15 | 冷却秒数 |
| TRIGGER_WINDOW_SECONDS | 1200 | 时间窗口（20 分钟） |

## 五、总结

- **改动小**：仅在超时分支增加约 6 行
- **复用现有**：`increment_verification_failures`、冷却、窗口
- **效果**：彻底堵住「间隔发违禁词」规避限制的漏洞
