# 霜刃（Bytecler）逻辑核查报告

## 一、业务不闭环 / 缺口

### 1. 验证超时无惩罚
- **现状**：用户 90 秒内未输入正确验证码时，仅 `pending_verification.pop()`，不加入黑名单、不限制
- **影响**：用户可故意不输入，超时后下次发言重新走流程，规避「错误 5 次即限制」
- **建议**：若需闭环，超时即视为失败 1 次并计入 `verification_failures`，或超时即限制（此前讨论过）

### 2. bio 关键词未使用 ✓ 已标注
- **现状**：`spam_keywords` 有 `bio` 字段，但群消息处理中从未调用 `check_spam_bio`
- **处理**：`/add_bio`、`/kw_bio`、`/list` 中已标注「bio 简介关键词暂未启用」

### 3. /reload 仅重载 spam_keywords
- **现状**：`cmd_reload` 只执行 `load_spam_keywords()`
- **影响**：修改 `verified_users.json`、`verification_blacklist.json` 等后需重启才能生效
- **建议**：扩展 `/reload` 支持重载白名单、黑名单、验证记录等，或拆分为 `/reload_kw`、`/reload_all`

---

## 二、可优化点

### 1. chat_member 调试日志
- **现状**：每次收到 `chat_member` 都打印 `[PTB] chat_member 收到: ...`
- **影响**：生产环境可能刷屏
- **建议**：改为 `logging.debug` 或通过配置开关控制

### 2. B 群信息缓存无过期
- **现状**：`_required_group_info_cache` 永久缓存，不设 TTL
- **影响**：B 群改标题或 username 后，重启前不会更新
- **建议**：加 TTL（如 1 小时）或在 `/reload` 时清空

### 3. exact 关键词用列表线性查找
- **现状**：`_check_field` 中 `for kw in (kw_cfg.get("exact") or []): if vl == kw.lower()`
- **影响**：exact 数量大时（如 >500）为 O(E)
- **建议**：改为 `set` 或预构建 `{k.lower(): k for k in exact}` 做 O(1) 查找

### 4. 验证记录无限增长
- **现状**：`save_verification_records` 在超过 10000 条时裁剪，但内存中 `_verification_records` 会持续增长
- **影响**：长期运行内存占用增加
- **建议**：当前 10000 条裁剪已可接受，可考虑按时间窗口定期清理更早记录

### 5. 自助解禁后未清 verification_failures
- **现状**：`callback_required_group_unrestrict` 清空 `_required_group_warn_count`，但未动 `verification_failures`
- **影响**：自助解禁仅用于「未加入 B 群」场景，该场景本身不涉及 `verification_failures`，无影响
- **结论**：可保持现状

---

## 三、流程闭环检查

| 流程 | 是否闭环 | 说明 |
|------|----------|------|
| 未加入 B 群 | ✓ | 冷却+窗口 5 次→限制→自助解禁可清空 |
| 验证码错误 5 次 | ✓ | 限制+黑名单，需 UNBAN_BOT 解封 |
| 验证超时 | ✗ | 仅 pop pending，无惩罚 |
| 管理员限制/封禁/踢出 | ✓ | 加黑名单+关键词 |
| 白名单用户离开 B 群 | ✓ | skip_cache 实时检查，会再次触发验证 |
| 新成员入群 | ✓ | 首次发言未命中规则则 whitelist_added |
| 霜刃 AI 唤醒 | ✓ | 可转交小助理 |
| 抽奖同步 | ✓ | 启动+每日 4 点 |

---

## 四、数据一致性

| 场景 | 一致性 |
|------|--------|
| 限制用户时 | 同时更新 blacklist、verified_users、verification_failures、pending_verification |
| 验证通过时 | 清空 verification_failures、blacklist、pending |
| 自助解禁时 | 加白、清 blacklist、清 _required_group_warn_count |
| 管理员封禁时 | 加 blacklist、加关键词、save |

---

## 五、建议优先级

| 优先级 | 项 | 工作量 |
|--------|-----|--------|
| 高 | 验证超时处理（按产品需求决定是否加惩罚） | 小 |
| ~~高~~ | ~~bio 关键词~~（已标注暂未启用） | ✓ |
| ~~中~~ | ~~2 秒延迟~~（不需要） | - |
| 中 | /reload 扩展 | 小 |
| 低 | chat_member 日志级别 | 小 |
| 低 | B 群缓存 TTL | 小 |
| 低 | exact 用 set 优化 | 小 |
