# 霜刃（Bytecler）功能梳理

## 一、核心定位

霜刃是 **Telegram 群组反垃圾机器人**，基于 python-telegram-bot (PTB)，实现关键词过滤、人机验证、B 群校验、白名单/黑名单管理、AI 唤醒等能力。

---

## 二、监控范围

| 项目 | 说明 |
|------|------|
| **监控群（TARGET_GROUP_IDS）** | 霜刃仅在这些群内处理消息 |
| **来源** | `GROUP_ID` 环境变量 + 私聊 `/add_group` 添加 |
| **类型** | 仅群（group/supergroup），不含频道 |
| **添加** | 私聊 `/add_group`，支持 @群、https://t.me/xxx、-100xxxxxxxxxx |

---

## 三、消息处理流程（按优先级）

1. **/setlimit 后续输入** | 群内配置 B 群，120 秒超时
2. **B 群校验** | 若未加入 B 群 → 删除消息 + 警告，冷却+窗口内 5 次后限制
3. **霜刃唤醒** | 以「霜刃，」开头、@霜刃、或回复霜刃的消息 → 调用 AI 回复
4. **白名单用户** | 直接通过，记录 verified_pass
5. **验证码回复** | 90 秒内正确 → 加白；错误 5 次 → 限制
6. **广告判定** | 含网页链接 + 文本 ≤10 字 → 触发验证
7. **Emoji 校验** | 消息或昵称含表情 → 触发验证（可 `ENABLE_EMOJI_CHECK=0` 关闭）
8. **引用非本群** | 回复的消息来自其他群 → 触发验证
9. **消息关键词** | 命中 text 关键词 → 触发验证
10. **昵称关键词** | 命中 name 关键词 → 触发验证
11. **黑名单** | 用户 ID 在黑名单 → 触发验证
12. **首次发言** | 未命中任何规则 → 直接加白（whitelist_added）

---

## 四、B 群校验

| 项目 | 说明 |
|------|------|
| **作用** | 用户必须加入指定群/频道后才能发言 |
| **配置** | 群内 `/setlimit`，仅拥有「可添加管理员」权限的管理员可配置 |
| **删除** | 群内 `/clearlimit` |
| **B 群类型** | 群或频道均可，`/setlimit` 支持 @频道、https、-100 形式 |
| **B 群与监控** | B 群不需要加入监控列表，霜刃只需加入 B 群（频道）即可校验 |
| **缓存** | 在：1 天；不在：10 秒；异常：默认用户在 B 群 |
| **限制** | 冷却 15 秒 + 窗口 20 分钟内 5 次 → 限制发言（默认 24 小时） |
| **自助解禁** | 警告消息带「自助解禁」按钮，加入 B 群后点击可解除限制 |

---

## 五、人机验证

### 5.1 触发场景

| 场景 | 说明 |
|------|------|
| spam_text | 消息命中 text 关键词 |
| spam_name | 昵称命中 name 关键词 |
| ad | 含网页链接且文本 ≤10 字 |
| emoji | 消息或昵称含表情（可关闭） |
| sticker | 发送贴纸（可 ENABLE_STICKER_CHECK=0 关闭） |
| reply_other_chat | 引用非本群消息 |
| blacklist | 黑名单用户 |

### 5.2 流程

- 删除原消息 → 发送 4 位验证码
- 90 秒内正确回复 → 加入白名单
- 错误 5 次 → 限制发言 + 加入黑名单
- 验证码消息可配置自动删除时间（默认 30 秒）

---

## 六、管理员操作联动

### 6.1 自动加黑名单

管理员对用户**封禁 / 限制 / 踢出**时，自动加入黑名单。

### 6.2 自动添加关键词

管理员**删除消息并限制/封禁/踢出**用户时：

- **昵称** → 加入 name 关键词（≤2 字精确，>2 字子串）
- **被删消息** → 加入 text 关键词（≤2 字精确，>2 字子串）
- 白名单中的昵称/消息不录入
- 消息缓存 24 小时，超时则只加昵称

---

## 七、AI 唤醒与 Handoff

### 7.1 霜刃 AI

- **触发**：以「霜刃，」开头、@提及霜刃、或回复霜刃的消息
- **能力**：调用 Kimi API 生成回复（冷酷女杀手人设，15 字以内）
- **转交**：若回复为「小助理，你来回答」→ 写入 handoff，由 xhchat 小助理回答

### 7.2 Frost Reply

霜刃回复含「霜刃」时，通过 handoff 由霜刃代为发送「......」。

---

## 八、抽奖白名单同步

| 项目 | 说明 |
|------|------|
| **数据源** | `LOTTERY_DB_PATH`（默认 `/tgbot/cjbot/cjdb/lottery.db`） |
| **环境** | 仅 Linux/Ubuntu，Windows 下跳过 |
| **时机** | 启动时 + 每日 4:00 UTC 定时 |
| **同步结果** | 向监控群发送「任务执行完毕」等文案 |

---

## 九、私聊命令（仅管理员）

| 命令 | 说明 |
|------|------|
| `/start` | 欢迎语 |
| `/help` | 完整指令说明 |
| `/add_group` | 添加霜刃可用群（支持 @群、https、-100 形式） |
| `/add_text` | 多轮添加消息关键词 |
| `/add_name` | 多轮添加昵称关键词 |
| `/add_bio` | 多轮添加简介关键词（暂未启用） |
| `/cancel` | 取消当前多轮操作 |
| `/reload` | 重载 spam_keywords、白名单、黑名单、B群配置、监控群列表 |
| `/settime` | 配置关联群验证/人机验证消息自动删除时间 |
| `/kw_text` | 消息关键词 add/remove/list |
| `/kw_name` | 昵称关键词 add/remove/list |
| `/kw_bio` | 简介关键词（暂未启用） |
| `/wl_name` | 昵称白名单 add/remove/list |
| `/wl_text` | 消息白名单 add/remove/list |
| **发送群消息链接** | 查看该消息的验证过程、触发原因、是否通过等 |

### 群内命令

| 命令 | 说明 |
|------|------|
| `/setlimit` | 配置本群 B 群/频道（需加入才能发言），仅拥有「可添加管理员」权限的管理员可配置 |
| `/clearlimit` | 删除本群 B 群配置 |

### 关键词规则

- **直接输入**（如 `加V`）→ 子串匹配
- **/前缀**（如 `/加微信`）→ 精确匹配
- **/正则/**（如 `/加微.*信/`）→ 正则匹配

---

## 十、数据文件

| 文件 | 说明 |
|------|------|
| `spam_keywords.json` | 垃圾关键词配置（text/name/bio + 白名单） |
| `verified_users.json` | 白名单用户 |
| `verification_blacklist.json` | 黑名单用户 |
| `verification_failures.json` | 验证失败计数 |
| `verification_records.json` | 验证记录（最多 10000 条） |
| `bgroup_config.json` | 每群 B 群配置 |
| `target_groups.json` | /add_group 添加的监控群 |
| `settime_config.json` | 自动删除时间配置 |
| `restricted_users.jsonl` | 封禁/限制/踢出日志 |
| `bio_calls.jsonl` | 被删除文案记录 |

---

## 十一、PTB 无法实现（Bot API 限制）

- **bio 关键词检测**：Bot API 不提供获取用户简介
- **私聊链接按 msg_id 拉消息**：需 MTProto

---

## 十二、群与频道现状

| 角色 | 群 | 频道 |
|------|-----|------|
| **监控群** | ✅ 支持 | ❌ 不支持 |
| **B 群** | ✅ 支持 | ✅ 支持 |

B 群可以是频道，无需加入监控列表；霜刃加入频道即可校验。监控群仅支持群聊。
