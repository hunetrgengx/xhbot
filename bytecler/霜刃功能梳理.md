# 霜刃（Bytecler）功能梳理

## 一、核心定位

霜刃是 **Telegram 群组反垃圾机器人**，基于 python-telegram-bot (PTB)，实现关键词过滤、人机验证、白名单/黑名单管理、AI 唤醒等能力。

---

## 二、反垃圾与验证

### 2.1 触发人机验证的场景

| 场景 | 说明 |
|------|------|
| **消息关键词** | 消息文本命中 text 关键词（exact 精确 / match 子串 / regex） |
| **昵称关键词** | 用户昵称命中 name 关键词 |
| **广告判定** | 消息含网页链接 + 文本 ≤10 字 |
| **引用非本群** | 回复的消息来自其他群 |
| **黑名单用户** | 用户 ID 在黑名单中 |

### 2.2 人机验证流程

- 删除原消息 → 发送验证码（4 位数字）
- 90 秒内正确回复验证码 → 加入白名单
- 错误 5 次 → 限制发言 + 加入黑名单
- 验证码消息 60 秒后自动删除

### 2.3 白名单逻辑

- **新成员入群**：自动加入白名单（可正常发言）
- **验证通过**：加入白名单
- **首次发言且未命中任何规则**：直接加入白名单（whitelist_added）

---

## 三、管理员操作联动

### 3.1 黑名单同步

管理员对用户进行以下操作时，自动将用户加入黑名单：

- **封禁**（banned）
- **踢出**（kicked）

### 3.2 自动添加关键词

管理员 **删除消息并限制/封禁/踢出** 用户时：

- **昵称** → 加入 name 关键词（≤2 字用精确，>2 字用子串）
- **被删消息** → 加入 text 关键词（≤2 字用精确，>2 字用子串）
- 消息缓存 TTL：24 小时，超时则只加昵称不加消息

---

## 四、AI 唤醒与 Handoff

### 4.1 霜刃 AI 唤醒

- **触发**：群内消息含「霜刃」或 @提及霜刃
- **能力**：调用 Kimi API 生成回复（冷酷女杀手人设，15 字以内）
- **转交**：若回复为「小助理，你来回答」→ 写入 handoff，由 xhchat 小助理回答

### 4.2 Frost Reply

霜刃回复含「霜刃」时，因 bot→bot 限制无法直接发送，通过 handoff 由霜刃代为发送「......」。

---

## 五、抽奖白名单同步

### 5.1 数据源

- **路径**：`LOTTERY_DB_PATH`（默认 `/tgbot/cjbot/cjdb/lottery.db`）
- **环境**：仅 Linux/Ubuntu，Windows 下跳过

### 5.2 同步时机

- **启动时**：全量同步 lottery.db 中奖用户到白名单
- **定时任务**：每日 4:00 UTC 再次同步

### 5.3 群内通知

同步完成后向监控群发送：

| 结果 | 文案 |
|------|------|
| 成功且有新增 | `任务执行完毕，已歼灭X人` |
| 成功且无新增 | `任务执行中` |
| 失败/跳过 | `任务失败，立即撤退` |

---

## 六、启动流程

1. 设置 Bot 菜单命令
2. 向监控群群发「你好」
3. 执行抽奖全量同步
4. 向监控群发送同步结果
5. 启动消息轮询

---

## 七、私聊命令（仅管理员）

| 命令 | 说明 |
|------|------|
| `/start` | 欢迎语 |
| `/help` | 完整指令说明 |
| `/list` | 查看 text/name/bio 关键词 |
| `/add_text` | 多轮添加消息关键词 |
| `/add_name` | 多轮添加昵称关键词 |
| `/add_bio` | 多轮添加简介关键词 |
| `/kw_text` | 消息关键词 add/remove |
| `/kw_name` | 昵称关键词 add/remove |
| `/kw_bio` | 简介关键词 add/remove |
| `/cancel` | 取消当前多轮操作 |
| `/reload` | 重载 spam_keywords.json |
| `/verified_stats` | 导出白名单用户统计 |

### 关键词规则

- **直接输入**（如 `加V`）→ 子串匹配
- **/前缀**（如 `/加微信`）→ 精确匹配
- **/正则/**（如 `/加微.*信/`）→ 正则匹配

---

## 八、验证记录查询

管理员私聊发送 **群消息链接**（如 `https://t.me/c/1330784088/123`），可查询该消息的验证过程、触发原因、是否通过等。

---

## 九、数据文件

| 文件 | 说明 |
|------|------|
| `spam_keywords.json` | 垃圾关键词配置 |
| `verified_users.json` | 白名单用户 |
| `verification_blacklist.json` | 黑名单用户 |
| `verification_failures.json` | 验证失败计数 |
| `verification_records.json` | 验证记录 |
| `restricted_users.jsonl` | 封禁/限制/踢出日志 |

---

## 十、PTB 无法实现（Bot API 限制）

- **bio 关键词检测**：Bot API 不提供获取用户简介
- **私聊链接按 msg_id 拉消息**：需 MTProto
