# 群组管理与权限设计方案

## 一、功能概览

| 功能 | 说明 | 粒度 |
|------|------|------|
| 自定义设定 | 每个群可配置独立的 custom_prompt | 按群组 |
| 模型切换 | 群内可切换 Kimi / Ollama / OpenAI 等 | 按群组 |
| 权限控制 | 谁可以修改这些配置 | 按角色 |

---

## 二、数据模型设计

### 1. 群组配置表 `group_settings`

```sql
CREATE TABLE group_settings (
    chat_id INTEGER PRIMARY KEY,           -- 群组 ID（负数）
    custom_prompt TEXT,                    -- 该群的自定义设定，NULL 表示用全局
    ai_provider TEXT NOT NULL DEFAULT 'kimi',  -- kimi | ollama | openai
    model_name TEXT,                       -- 模型名，NULL 用该 provider 默认
    openai_base_url TEXT,                  -- 可选，如 Ollama 的 http://localhost:11434/v1
    openai_api_key TEXT,                   -- 可选，群级 API Key，NULL 用全局
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. 管理员表 `admins`（权限控制）

```sql
CREATE TABLE admins (
    user_id INTEGER PRIMARY KEY,           -- Telegram user_id
    role TEXT NOT NULL,                    -- global_admin | group_admin（owner 不进表）
    scope_chat_ids TEXT,                   -- group_admin 时生效，逗号分隔的 chat_id
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3. 角色定义

| 角色 | 权限范围 | 典型用途 |
|------|----------|----------|
| **owner** | 全局 + 所有群 | Bot 主人，.env 中配置 |
| **global_admin** | 所有群的管理 | 副管理、运维 |
| **group_admin** | 指定群（scope_chat_ids） | 某群负责人 |

---

## 三、模型与配置体系

### 1. 配置优先级（从高到低）

| 层级 | custom_prompt | ai_provider | model_name | base_url | api_key |
|------|---------------|-------------|------------|----------|---------|
| 群组 | group_settings | group_settings | group_settings | group_settings | group_settings |
| 全局 | .env / custom_prompt.txt | .env | .env | .env | .env |

### 2. 预置模型方案

```
方案 ID           | provider | model_name              | base_url
------------------|----------|-------------------------|----------------------------
kimi              | kimi     | moonshot-v1-128k        | (默认)
kimi-k2           | kimi     | kimi-k2-turbo-preview   | (默认)
ollama-qwen       | ollama   | qwen2.5                 | http://localhost:11434/v1
ollama-llama      | ollama   | llama3.2                | http://localhost:11434/v1
openai            | openai   | gpt-4o-mini             | (默认)
deepseek          | deepseek | deepseek-chat           | https://api.deepseek.com/v1
```

群组可选用「预置方案」或「自定义」；自定义时填 provider、model、base_url、api_key。

---

## 四、管理入口设计

### 1. 命令清单

| 命令 | 说明 | 使用场景 |
|------|------|----------|
| `/settings` | 查看当前群配置 | 群内 / 私聊 |
| `/set_prompt` | 设置本群 custom_prompt | 群内 |
| `/set_model <方案>` | 切换模型方案 | 群内 |
| `/reset_prompt` | 恢复用全局 prompt | 群内 |
| `/reset_model` | 恢复用全局模型 | 群内 |
| `/admin add <user_id>` | 添加管理员（owner） | 私聊 owner |
| `/admin remove <user_id>` | 移除管理员 | 私聊 owner |
| `/admin list` | 列出管理员 | 私聊 owner |

### 2. 交互方式

**方式 A：命令 + 回复**

```
用户: /set_prompt
Bot: 请回复一条消息作为本群的自定义设定，或发送 /cancel 取消

用户: [回复一条长消息]
Bot: ✅ 已更新本群设定。
```

**方式 B：Inline Keyboard（推荐）**

```
/settings 回复示例：

当前群配置
├ 模型：Kimi (moonshot-v1-128k)
├ 自定义设定：已设置 (共 120 字)
└ [切换模型] [编辑设定] [恢复默认]
```

### 3. 模型切换流程

```
/set_model
  → [Kimi] [Kimi K2] [Ollama-Qwen] [Ollama-Llama] [自定义]

选「自定义」→ 引导输入：provider, model, base_url（api_key 可选，默认用全局）
```

---

## 五、权限控制（详细设计）

### 1. 角色与来源

| 角色 | 来源 | 是否存数据库 | 说明 |
|------|------|--------------|------|
| **owner** | .env 中 `BOT_OWNER_ID` | ❌ 否 | 唯一，Bot 创建者，最高权限 |
| **global_admin** | owner 通过 `/admin add` 添加 | ✅ admins 表 | 可管理所有群，可被 owner 撤销 |
| **group_admin** | owner 通过 `/admin add` 添加 | ✅ admins 表 | 仅管理 scope_chat_ids 中的群 |

**重要**：owner 不写入 admins 表，避免被误删，始终以 .env 为准。

---

### 2. 如何获取 Telegram user_id

| 方式 | 说明 |
|------|------|
| 私聊 @userinfobot | 发送任意消息，Bot 会回复你的 user_id |
| 开发者调试 | 在代码里 `print(update.effective_user.id)`，发一条消息触发 |
| 转发消息 | 用户转发自己发的消息给 Bot，从 `forward_from.id` 读取 |

建议：首次使用时，让用户在私聊中发送 `/start`，Bot 回复「你的 user_id 是 xxx，请将此 ID 填入 BOT_OWNER_ID」。

---

### 3. 权限矩阵（谁能在哪里执行什么）

| 操作 | owner | global_admin | group_admin | Telegram 群管 | 普通用户 |
|------|:-----:|:------------:|:-----------:|:-------------:|:--------:|
| 查看群配置 /settings | ✅ | ✅ | ✅ 仅 scope 内群 | ✅ 本群 | ✅ 本群 |
| 修改本群 prompt/model | ✅ | ✅ | ✅ 仅 scope 内群 | ⚪ 可配置 | ❌ |
| 添加/删除 global_admin | ✅ | ❌ | ❌ | ❌ | ❌ |
| 添加/删除 group_admin | ✅ | ⚪ 可扩展 | ❌ | ❌ | ❌ |
| 查看 api_key 等敏感信息 | ✅ | ❌ | ❌ | ❌ | ❌ |

⚪ = 可选实现

---

### 4. 校验逻辑（伪代码）

```python
# 配置项
BOT_OWNER_ID = int(os.getenv("BOT_OWNER_ID", "0"))      # 0 表示未配置
ALLOW_TELEGRAM_ADMIN = True   # 是否允许「Telegram 群管理员」管理本群

def can_manage_group(user_id: int, chat_id: int, bot) -> bool:
    """用户是否有权管理该群的配置（set_prompt / set_model 等）"""
    # 1. 私聊场景：chat_id > 0，仅 owner 可管理「全局默认」或视为无群上下文
    if chat_id > 0:
        return user_id == BOT_OWNER_ID

    # 2. 群组场景：chat_id < 0
    # 2.1 Owner 最高权限
    if BOT_OWNER_ID and user_id == BOT_OWNER_ID:
        return True

    # 2.2 数据库中的 global_admin
    if get_admin_role(user_id) == "global_admin":
        return True

    # 2.3 数据库中的 group_admin，且 chat_id 在其 scope 内
    admin = get_admin(user_id)
    if admin and admin["role"] == "group_admin" and admin["scope_chat_ids"]:
        scope_ids = [int(x) for x in admin["scope_chat_ids"].split(",") if x.strip()]
        if chat_id in scope_ids:
            return True

    # 2.4 可选：Telegram 群管理员（需调用 Telegram API）
    if ALLOW_TELEGRAM_ADMIN:
        try:
            member = bot.get_chat_member(chat_id=chat_id, user_id=user_id)
            # creator=群主, administrator=管理员
            if member.status in ("creator", "administrator"):
                return True
        except Exception:
            pass

    return False


def can_manage_admins(user_id: int) -> bool:
    """是否有权执行 /admin add|remove|list（仅 owner）"""
    return BOT_OWNER_ID and user_id == BOT_OWNER_ID


def can_view_sensitive_config(user_id: int) -> bool:
    """是否有权查看 api_key 等敏感配置（仅 owner）"""
    return BOT_OWNER_ID and user_id == BOT_OWNER_ID
```

---

### 5. Telegram 群管理员判断

Telegram Bot API：`getChatMember(chat_id, user_id)` 返回的 `status`：

| status | 含义 |
|--------|------|
| `creator` | 群主 |
| `administrator` | 管理员 |
| `member` | 普通成员 |
| `restricted` | 受限 |
| `left` | 已退出 |
| `kicked` | 已被踢 |

**实现**：`status in ("creator", "administrator")` 即视为有群管理权限。

**注意**：每次校验都会调用一次 API，可对结果做短期缓存（如 5 分钟），减少请求。

---

### 6. 命令执行上下文与权限

| 命令 | 执行场景 | 权限要求 | 说明 |
|------|----------|----------|------|
| `/settings` | 群内 / 私聊 | 无 | 所有人可查看，敏感信息仅 owner 可见 |
| `/set_prompt` | 仅群内 | can_manage_group | 私聊下发此命令可提示「请在群内使用」 |
| `/set_model` | 仅群内 | can_manage_group | 同上 |
| `/reset_prompt` | 仅群内 | can_manage_group | 同上 |
| `/reset_model` | 仅群内 | can_manage_group | 同上 |
| `/admin add` | 仅私聊 | can_manage_admins | 防止在群内暴露 user_id 等 |
| `/admin remove` | 仅私聊 | can_manage_admins | 同上 |
| `/admin list` | 仅私聊 | can_manage_admins | 同上 |

---

### 7. 无权限时的统一回复

```
❌ 权限不足。只有群管理员或 Bot 管理员可以修改本群配置。
```

或更简版：

```
❌ 你没有权限执行此操作。
```

建议：不暴露「谁有权限」，避免被针对。

---

### 8. 安全注意事项

| 风险 | 措施 |
|------|------|
| owner 被冒充 | owner 仅从 .env 读取，不通过命令修改 |
| api_key 泄露 | /settings 中 api_key 脱敏或仅 owner 可见 |
| 越权管理其他群 | 严格按 scope_chat_ids 校验 group_admin |
| 频繁 getChatMember | 对结果做 5 分钟缓存，避免 API 限流 |
| 恶意刷管理命令 | 对非 owner 的 /admin 直接忽略，不返回任何内容 |

---

### 9. 可选：操作日志

如需审计，可增加 `admin_logs` 表：

```sql
CREATE TABLE admin_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    chat_id INTEGER,
    action TEXT NOT NULL,    -- set_prompt | set_model | admin_add | ...
    detail TEXT,             -- 变更内容摘要
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

在每次成功执行管理操作后写入一条记录，便于事后排查。

---

## 六、目录与模块规划

```
bot/
├── handlers/
│   ├── start.py
│   ├── chat.py
│   └── admin.py          # 新增：管理命令
├── services/
│   ├── ai_service.py     # 改造：接收 chat_id，按群取配置
│   ├── group_config.py   # 新增：群组配置读写
│   └── permission.py     # 新增：权限校验
├── models/
│   ├── database.py       # 新增 group_settings, admins 表
│   └── ...
```

---

## 七、实现顺序建议

| 阶段 | 内容 | 优先级 |
|------|------|--------|
| P0 | 数据库：group_settings 表 + 读写 | 1 |
| P0 | 权限：BOT_OWNER_ID + can_manage_group | 2 |
| P0 | ai_service：按 chat_id 读取配置（prompt + model） | 3 |
| P1 | /set_model：预置方案切换 | 4 |
| P1 | /set_prompt：群组 custom_prompt | 5 |
| P1 | /settings：查看当前配置 | 6 |
| P2 | admins 表 + /admin 命令 | 7 |
| P2 | Inline Keyboard 交互 | 8 |
| P3 | 自定义模型（手动填 base_url 等） | 9 |

---

## 八、配置示例

### 群 A（默认 Kimi）

```
chat_id: -100123456
custom_prompt: (空，用全局)
ai_provider: kimi
model_name: moonshot-v1-128k
```

### 群 B（Ollama 本地）

```
chat_id: -100789012
custom_prompt: 你是技术群助手，侧重编程...
ai_provider: ollama
model_name: qwen2.5
openai_base_url: http://localhost:11434/v1
```

---

## 九、边界情况

1. **私聊**：chat_id > 0，可用「全局配置」或为用户建一份虚拟配置（按需）
2. **Ollama 未启动**：切换后首次调用失败，提示「Ollama 服务不可用，请检查」
3. **新群**：首次 /settings 时自动插入默认记录
4. **机器人被移出群**：可定期清理已不存在群组的配置（可选）

---

## 十、总结

| 维度 | 设计要点 |
|------|----------|
| **数据** | group_settings 存群级配置，admins 管权限 |
| **配置** | 群组 > 全局，支持预置 + 自定义模型 |
| **权限** | owner / global_admin / group_admin，可扩展 Telegram 群管 |
| **交互** | 命令为主，可选 Inline Keyboard |
| **实现** | 先做配置与权限，再接入 ai_service |

可按上述阶段分步实现，如需我帮你落到具体代码（如 `group_config.py`、权限校验、`ai_service` 改造），可以说下你打算从哪一步开始。
