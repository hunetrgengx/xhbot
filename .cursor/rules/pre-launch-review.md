# 上线前代码审查 Prompt（通用）

将以下 prompt 复制给大模型，并附上项目/模块的代码或路径，用于上线前全面检查。

---

## Prompt 正文

```
请对以下项目/模块进行「上线前」全面审查，从以下维度逐一检查并给出结论与建议：

---

## 1. Bug 与逻辑错误

- **空指针/未定义**：是否存在未处理的 None、空值、异常类型导致崩溃？
- **参数缺失**：异步/同步调用是否传齐所有必需参数？是否存在参数顺序错误？
- **边界条件**：数组越界、除零、空集合/空字符串处理是否完备？
- **异常处理**：try/except 是否覆盖关键路径？是否吞掉异常导致问题难以排查？
- **竞态与并发**：多线程/多协程下共享状态是否安全？有无 race condition？

---

## 2. 业务逻辑闭环

- **流程完整性**：核心业务流程是否覆盖所有分支？有无未处理的中间状态？
- **状态机**：pending 状态是否有超时/取消/完成路径？用户中断后状态是否可恢复？
- **权限与校验**：鉴权、权限检查是否在所有敏感操作前执行？有无越权/越界风险？
- **依赖与前置**：外部系统/API 失败时是否有降级、重试或明确提示？
- **数据一致性**：读写操作是否考虑并发？是否可能出现脏读/脏写？

---

## 3. 长期运行与数据量风险

- **内存无界增长**：哪些 dict/list/set 只增不减？有无 TTL、LRU 或定期清理？
- **缓存**：缓存是否过期删除？过期 key 是否长期占用内存？
- **文件**：append-only 日志是否轮转？单文件是否有大小上限？磁盘满时如何处理？
- **持久化**：大表/大文件加载时是否全量读入内存？是否需分页或流式处理？
- **定时任务**：周期任务是否可能阻塞主流程？有无堆积与超时风险？

---

## 4. 配置与安全

- **敏感信息**：Token、密钥、密码是否硬编码？是否通过环境变量或加密配置？
- **必填项**：启动依赖的配置缺失时是否有明确报错？能否引导正确配置？
- **路径与权限**：文件路径是否跨平台兼容？是否有写权限或目录存在性检查？

---

## 5. 可观测与运维

- **日志**：关键路径是否有日志？异常是否有堆栈？日志是否便于排查问题？
- **监控**：是否有可量化的指标（如 QPS、错误率、队列长度）？是否便于告警？
- **优雅退出**：进程收到 SIGTERM/SIGINT 时是否正常释放资源、保存状态？

---

## 6. 性能与资源

- **阻塞操作**：同步 IO、长循环是否阻塞事件循环？是否应改为异步或后台执行？
- **慢路径**：有无 N+1 查询、全量加载、大循环？高并发下是否成为瓶颈？
- **资源泄漏**：连接、句柄、定时器是否在异常路径正确关闭？
- **超时**：外部调用是否设置超时？超时值是否合理？

---

## 7. 兼容性与依赖

- **多平台**：路径、编码、系统调用是否兼容 Windows/Linux/macOS？
- **依赖版本**：requirements 是否锁定版本？有无已知安全漏洞？
- **向后兼容**：配置/数据格式变更时，旧数据能否正常加载？有无迁移脚本？
- **环境差异**：开发/测试/生产环境差异是否明确？有无环境特定逻辑？

---

## 8. 用户体验与降级

- **错误提示**：用户可见的错误信息是否友好、可操作？是否暴露内部细节？
- **超时与重试**：用户等待是否过长？失败后是否有重试入口或明确指引？
- **降级策略**：核心依赖不可用时，是否有降级、排队或友好提示？
- **幂等性**：重复操作（如双击、网络重试）是否会产生副作用？

---

## 9. 数据隐私与合规

- **敏感数据**：用户 ID、手机号、IP 等是否写入日志？是否需要脱敏？
- **数据留存**：日志、缓存、持久化数据的保留时长是否合规？
- **第三方共享**：是否向外部传输用户数据？是否有授权与加密？

---

## 10. 可扩展性与韧性

- **单点故障**：有无单点（单进程、单文件、单实例）？故障影响范围？
- **水平扩展**：多实例部署时，共享状态、定时任务是否冲突？
- **重试与熔断**：外部调用失败时是否有重试？是否有熔断避免雪崩？
- **限流**：对外暴露的接口是否有限流？是否可能被滥用？

---

## 输出格式

请按以下结构输出：

| 维度 | 检查项 | 结论（通过/风险/问题） | 具体说明与建议 |
|------|--------|------------------------|----------------|
| 1 | 空指针/未定义 | ... | ... |
| ... | ... | ... | ... |

**优先级建议**：列出需要在上线前修复的问题（按 P0/P1/P2 优先级）及建议修复项。
```

---

## 使用示例

- 单文件：`请审查 @xxx/bot.py` 并附上上述 prompt
- 模块：`请审查 @xxx/bytecler/ 目录下的核心逻辑` 并附上上述 prompt
- 全项目：`请审查 @xxx 项目，重点关注 main.py、bytecler/、xhchat/ 等入口与核心模块` 并附上上述 prompt

---

## 适用场景

- 新功能上线前
- 定期代码健康检查
- 重构/迁移后的验证
- 接手新项目时的快速评估
